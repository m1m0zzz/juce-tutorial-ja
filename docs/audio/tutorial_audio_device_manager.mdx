---
title: AudioDeviceManagerクラス
sidebar_position: 6
tags: [中級]
---

# チュートリアル: AudioDeviceManagerクラス

<SourcePageLink path="tutorial_audio_device_manager" />

このチュートリアルでは、すべてのプラットフォームでオーディオデバイスを管理するために使用される[AudioDeviceManager](https://docs.juce.com/master/classAudioDeviceManager.html "Manages the state of some audio and midi i/o devices.")クラスを紹介します。これにより、デバイスのサンプルレートや入出力の数などを設定できます。

**レベル:** 中級<br/>
**プラットフォーム:** Windows, macOS, Linux, iOS, Android<br/>
**クラス:** [AudioDeviceManager](https://docs.juce.com/master/classAudioDeviceManager.html "Manages the state of some audio and midi i/o devices."), [AudioDeviceSelectorComponent](https://docs.juce.com/master/classAudioDeviceSelectorComponent.html "A component containing controls to let the user change the audio settings of an AudioDeviceManager ob..."), [ChangeListener](https://docs.juce.com/master/classChangeListener.html "Receives change event callbacks that are sent out by a ChangeBroadcaster."), [BigInteger](https://docs.juce.com/master/classBigInteger.html "An arbitrarily large integer class.")

## はじめに

:::tip
このチュートリアルでは、オーディオの入出力に[AudioAppComponent](https://docs.juce.com/master/classAudioAppComponent.html "A base class for writing audio apps that stream from the audio i/o devices.")クラスを使用する基本的な理解があることを前提としています([Tutorial: Processing audio input](../tutorial_processing_audio_input/)を参照)。また、基本的なGUIレイアウト技術に精通していることも前提としています([Tutorial: Parent and child components](../../interface-design/tutorial_component_parents_children/)を参照)。
:::

このチュートリアルのデモプロジェクトをダウンロードしてください: [PIP](https://docs.juce.com/tutorials/PIPs/AudioDeviceManagerTutorial.zip) \| [ZIP](https://docs.juce.com/tutorials/ZIPs/AudioDeviceManagerTutorial.zip)。プロジェクトを解凍し、Projucerで最初のヘッダーファイルを開いてください。

この手順でヘルプが必要な場合は、[Tutorial: Projucer Part 1: Getting started with the Projucer](../../getting-started/tutorial_new_projucer_project/)を参照してください。

## デモプロジェクト

このデモプロジェクトは、Projucerのオーディオアプリケーションテンプレートをベースにしています。[AudioDeviceSelectorComponent](https://docs.juce.com/master/classAudioDeviceSelectorComponent.html "A component containing controls to let the user change the audio settings of an AudioDeviceManager ob...")オブジェクトを表示し、オーディオデバイス設定を構成できます。また、現在のオーディオデバイス設定を報告するシンプルなテキストコンソールも表示します。アプリケーションは、オーディオ処理要素の現在のCPU使用率も表示します。

:::tip
ここで紹介するコードは、JUCEデモの**AudioSettingsDemo**と大まかに似ています。主な違いは、生成されるオーディオが[Tutorial: Processing audio input](../tutorial_processing_audio_input/)と同じであることです(これはオーディオ入力をホワイトノイズでリング変調します)。
:::

<CaptionImage
  src="/_images/tutorial_audio_device_manager_screenshot1.png"
  caption="An AudioDeviceSelectorComponent object showing settings for an AudioDeviceManager object"
  alt=""
/>

## オーディオデバイス

JUCEは、サポートするすべてのプラットフォームでオーディオデバイスにアクセスするための一貫した手段を提供します。ここで提供されるデモアプリケーションはデスクトッププラットフォームにのみデプロイされる可能性がありますが、これはGUIレイアウトの制約によるものです。オーディオはモバイルプラットフォームでもシームレスに動作します。

オーディオアプリケーションテンプレートでは、[AudioAppComponent](https://docs.juce.com/master/classAudioAppComponent.html "A base class for writing audio apps that stream from the audio i/o devices.")クラスが[AudioDeviceManager](https://docs.juce.com/master/classAudioDeviceManager.html "Manages the state of some audio and midi i/o devices.")オブジェクト`deviceManager`をインスタンス化します --- これはpublicメンバーであるため、サブクラスからアクセスできます。[AudioAppComponent](https://docs.juce.com/master/classAudioAppComponent.html "A base class for writing audio apps that stream from the audio i/o devices.")クラスは、この[AudioDeviceManager](https://docs.juce.com/master/classAudioDeviceManager.html "Manages the state of some audio and midi i/o devices.")オブジェクトの基本的な初期化も実行します --- これは[AudioAppComponent::setAudioChannels()](https://docs.juce.com/master/classAudioAppComponent.html#a1cb6b457848fa80df7efc39cf095d465 "A subclass should call this from their constructor, to set up the audio.")を呼び出すときに行われます。

[AudioDeviceManager](https://docs.juce.com/master/classAudioDeviceManager.html "Manages the state of some audio and midi i/o devices.")クラスは、オーバーライドされない限り、デフォルトのオーディオデバイスを使用しようとします。これはコードで構成するか、ここで説明する[AudioDeviceSelectorComponent](https://docs.juce.com/master/classAudioDeviceSelectorComponent.html "A component containing controls to let the user change the audio settings of an AudioDeviceManager ob...")を介して構成できます。デバイスの設定と環境設定は、その後のアプリケーション起動時に保存および呼び出すことができます。[AudioDeviceManager](https://docs.juce.com/master/classAudioDeviceManager.html "Manages the state of some audio and midi i/o devices.")クラスは、優先デバイスが使用できなくなった場合(たとえば、前回の起動以降に外部オーディオデバイスが取り外された場合)、このような状況でデフォルトデバイスにフォールバックすることもできます。

[AudioDeviceManager](https://docs.juce.com/master/classAudioDeviceManager.html "Manages the state of some audio and midi i/o devices.")クラスは、受信MIDIメッセージのハブでもあります。これについては他のチュートリアルで説明します([Tutorial: Handling MIDI events](../../midi/tutorial_handling_midi_events/)を参照)。

[AudioDeviceManager](https://docs.juce.com/master/classAudioDeviceManager.html "Manages the state of some audio and midi i/o devices.")クラスは、[ChangeBroadcaster](https://docs.juce.com/master/classChangeBroadcaster.html "Holds a list of ChangeListeners, and sends messages to them when instructed.")クラスを継承しているため、設定の変更をブロードキャストできます。コンポーネントの右側には、[AudioDeviceManager](https://docs.juce.com/master/classAudioDeviceManager.html "Manages the state of some audio and midi i/o devices.")オブジェクトの変更がトリガーされるたびに、重要なオーディオデバイス設定の一部が表示されます。

### AudioDeviceSelectorComponentクラス

[AudioDeviceSelectorComponent](https://docs.juce.com/master/classAudioDeviceSelectorComponent.html "A component containing controls to let the user change the audio settings of an AudioDeviceManager ob...")クラスは、すべてのプラットフォームでオーディオデバイスを構成するための便利な方法を提供します。前述のように、これはデモプロジェクトのユーザーインターフェイスの右側に表示されます。[AudioDeviceSelectorComponent](https://docs.juce.com/master/classAudioDeviceSelectorComponent.html "A component containing controls to let the user change the audio settings of an AudioDeviceManager ob...")オブジェクトが構築されるとき、制御したい[AudioDeviceManager](https://docs.juce.com/master/classAudioDeviceManager.html "Manages the state of some audio and midi i/o devices.")オブジェクトを、サポートするチャンネル数を含む他の多くのオプションと一緒に渡します(詳細については、[AudioDeviceSelectorComponent](https://docs.juce.com/master/classAudioDeviceSelectorComponent.html "A component containing controls to let the user change the audio settings of an AudioDeviceManager ob...")クラスの[コンストラクタ](https://docs.juce.com/master/classAudioDeviceSelectorComponent.html#a859af6ef664a974dc7d2ce3d24d8f94c)を参照してください)。ここでは、[AudioAppComponent](https://docs.juce.com/master/classAudioAppComponent.html "A base class for writing audio apps that stream from the audio i/o devices.")のメンバーである[AudioDeviceManager](https://docs.juce.com/master/classAudioDeviceManager.html "Manages the state of some audio and midi i/o devices.")オブジェクトを渡し、最大256の入出力チャンネルを許可し、MIDI設定を非表示にし、チャンネルをステレオペアではなく単一チャンネルとして表示することで、[AudioDeviceSelectorComponent](https://docs.juce.com/master/classAudioDeviceSelectorComponent.html "A component containing controls to let the user change the audio settings of an AudioDeviceManager ob...")オブジェクトを作成します:

```cpp
MainContentComponent()
    : audioSetupComp (deviceManager,
          0, // minimum input channels
          256, // maximum input channels
          0, // minimum output channels
          256, // maximum output channels
          false, // ability to select midi inputs
          false, // ability to select midi output device
          false, // treat channels as stereo pairs
          false) // hide advanced options
{
```

インターフェイスは、以下を制御できるように構成されています:

- 出力デバイスの選択。
- 入力デバイスの選択。
- 入出力チャンネルの有効化と無効化。

`changeListenerCallback()`関数では、[AudioDeviceManager](https://docs.juce.com/master/classAudioDeviceManager.html "Manages the state of some audio and midi i/o devices.")オブジェクトにアクセスして現在のオーディオデバイスを取得する`dumpDeviceInfo()`関数を呼び出します。次に、デバイスに関するさまざまな情報を取得します:

```cpp
void dumpDeviceInfo()
{
    logMessage ("--------------------------------------");
    logMessage ("Current audio device type: " + (deviceManager.getCurrentDeviceTypeObject() != nullptr ? deviceManager.getCurrentDeviceTypeObject()->getTypeName() : "<none>"));

    if (auto* device = deviceManager.getCurrentAudioDevice())
    {
        logMessage ("Current audio device: " + device->getName().quoted());
        logMessage ("Sample rate: " + juce::String (device->getCurrentSampleRate()) + " Hz");
        logMessage ("Block size: " + juce::String (device->getCurrentBufferSizeSamples()) + " samples");
        logMessage ("Bit depth: " + juce::String (device->getCurrentBitDepth()));
        logMessage ("Input channel names: " + device->getInputChannelNames().joinIntoString (", "));
        logMessage ("Active input channels: " + getListOfActiveBits (device->getActiveInputChannels()));
        logMessage ("Output channel names: " + device->getOutputChannelNames().joinIntoString (", "));
        logMessage ("Active output channels: " + getListOfActiveBits (device->getActiveOutputChannels()));
    }
    else
    {
        logMessage ("No audio device open");
    }
}
```

:::tip
`getListOfActiveBits()`関数を使用して、アクティブなチャンネルのリストを*ビットマスク*として表す[BigInteger](https://docs.juce.com/master/classBigInteger.html "An arbitrarily large integer class.")オブジェクトを[String](https://docs.juce.com/master/classString.html "The JUCE String class!")オブジェクトに変換します。[BigInteger](https://docs.juce.com/master/classBigInteger.html "An arbitrarily large integer class.")オブジェクトは、[std::bitset](http://www.cplusplus.com/reference/bitset/bitset/)や[std::vector\<bool\>](http://www.cplusplus.com/reference/vector/vector-bool/)と同様にビットマスクとして使用されます。ここでは、チャンネルは[BigInteger](https://docs.juce.com/master/classBigInteger.html "An arbitrarily large integer class.")値を構成するビット内の0(非アクティブ)または1(アクティブ)で表されます。[BigInteger](https://docs.juce.com/master/classBigInteger.html "An arbitrarily large integer class.")オブジェクトで実行できる他の操作については、[Tutorial: The BigInteger class](../../utility-classes/tutorial_big_integer/)を参照してください。
:::

このような変更に応答することは、実際のアプリケーションで非常に便利です。アプリケーションで使用可能なチャンネル数が変更された場合に知る必要があることがよくあります。多くの場合、サンプルレートや他のオーディオパラメータの変更に適切に対応することが重要です。

:::note
演習: [AudioDeviceSelectorComponent](https://docs.juce.com/master/classAudioDeviceSelectorComponent.html "A component containing controls to let the user change the audio settings of an AudioDeviceManager ob...")クラスのコンストラクタのさまざまな設定を試してみてください --- これは、アプリケーションがアドレス指定できるチャンネル数を制限できるマルチチャンネルサウンドカードをお持ちの場合に特に便利です。また、チャンネルのペアをステレオペアとして表示する方法も確認できます。
:::

[AudioDeviceSelectorComponent](https://docs.juce.com/master/classAudioDeviceSelectorComponent.html "A component containing controls to let the user change the audio settings of an AudioDeviceManager ob...")クラスには、**Test**ボタンも含まれています。これにより、デバイス出力からサイントーンが再生され、ユーザーがターゲットデバイスでオーディオ出力が機能していることをテストするのに役立ちます。

### CPU使用率

[AudioDeviceManager::getCpuUsage()](https://docs.juce.com/master/classAudioDeviceManager.html#a79563c9d2cc87d059d8b101515e8dee1 "Returns the average proportion of available CPU being spent inside the audio callbacks.")関数を呼び出すことで、アプリケーションのオーディオ処理要素のCPU使用率を取得します。`MainContentComponent`クラスでは、[Timer](https://docs.juce.com/master/classTimer.html "Makes repeated callbacks to a virtual method at a specified time interval.")クラスを継承し、50msごとにトリガーするようにタイマーを開始します。`timerCallback()`関数では、[AudioDeviceManager](https://docs.juce.com/master/classAudioDeviceManager.html "Manages the state of some audio and midi i/o devices.")オブジェクトからCPU使用率を取得します。この値は、[Label](https://docs.juce.com/master/classLabel.html "A component that displays a text string, and can optionally become a text editor when clicked.")オブジェクトにパーセンテージ(小数点以下6桁)として表示されます:

```cpp
void timerCallback() override
{
    auto cpu = deviceManager.getCpuUsage() * 100;
    cpuUsageText.setText (juce::String (cpu, 6) + " %", juce::dontSendNotification);
}
```

この特定のアプリケーションでは、オーディオ処理がほとんど行われていないため、CPU使用率は非常に低くなる可能性があります --- 多くのターゲットデバイスでおそらく1%未満です。ただし、さまざまな設定の組み合わせを試すことで、サンプルレートとバッファサイズがCPU負荷に与える影響を確認できます。一般的に、サンプルレートが高く、バッファサイズが小さいほど、CPUの使用量が多くなります。

## まとめ

このチュートリアルでは、[AudioDeviceManager](https://docs.juce.com/master/classAudioDeviceManager.html "Manages the state of some audio and midi i/o devices.")クラスとオーディオデバイス全般の機能の一部を紹介しました。以下の方法がわかるようになったはずです:

- オーディオアプリケーションテンプレートを使用して、[AudioAppComponent](https://docs.juce.com/master/classAudioAppComponent.html "A base class for writing audio apps that stream from the audio i/o devices.")オブジェクト内から[AudioDeviceManager](https://docs.juce.com/master/classAudioDeviceManager.html "Manages the state of some audio and midi i/o devices.")オブジェクトにアクセスする。
- [AudioDeviceManager](https://docs.juce.com/master/classAudioDeviceManager.html "Manages the state of some audio and midi i/o devices.")オブジェクトを制御するための[AudioDeviceSelectorComponent](https://docs.juce.com/master/classAudioDeviceSelectorComponent.html "A component containing controls to let the user change the audio settings of an AudioDeviceManager ob...")オブジェクトを作成する。
- オーディオデバイスの変更に応答する。
- サンプルレートや使用可能なチャンネル数など、オーディオデバイス内の有用な設定にアクセスする。

## 関連項目

- [Tutorial: Processing audio input](../tutorial_processing_audio_input/)
