---
title: MPE ゾーンを理解する
sidebar_position: 5
tags: [中級]
---

# チュートリアル: MPE ゾーンを理解する

<SourcePageLink path="tutorial_mpe_zones" />

MPE 規格で定義されているゾーンの概念とゾーンレイアウトの規約を学びます。MPE シンセサイザーを MPE 対応デバイスに接続しましょう。

**レベル:** 中級<br/>
**プラットフォーム:** Windows, macOS, Linux<br/>
**クラス:** [MPEZoneLayout](https://docs.juce.com/master/classMPEZoneLayout.html "This class represents the current MPE zone layout of a device capable of handling MPE."), MPEZoneLayout::Zone, [MPEMessages](https://docs.juce.com/master/classMPEMessages.html "This helper class contains the necessary helper functions to generate MIDI messages that are exclusiv..."), [MPESynthesiser](https://docs.juce.com/master/classMPESynthesiser.html "Base class for an MPE-compatible musical device that can play sounds.")

## はじめに

このチュートリアルのデモプロジェクトをダウンロードしてください: [PIP](https://docs.juce.com/tutorials/PIPs/MPEZonesTutorial.zip) \| [ZIP](https://docs.juce.com/tutorials/ZIPs/MPEZonesTutorial.zip) 。プロジェクトを解凍し、最初のヘッダーファイルを Projucer で開きます。

この手順でヘルプが必要な場合は、[チュートリアル: Projucer Part 1: Projucer の使い方](../../getting-started/tutorial_new_projucer_project/)を参照してください。

:::tip
いくつかの箇所で参考にしているため、先に[チュートリアル: マルチポリフォニックシンセサイザーの構築](../tutorial_mpe_introduction/)を読んでおくと役立ちます。
:::

## デモプロジェクト

デモプロジェクトは、`JUCE/examples` ディレクトリにある `MPEDemo` プロジェクトに似ており、[チュートリアル: マルチポリフォニックシンセサイザーの構築](../tutorial_mpe_introduction/)の簡略版を基にしています。このチュートリアルを最大限に活用するには、[MPE](https://support.roli.com/article/what-is-mpe/) 対応コントローラーが必要です。[MPE](https://support.roli.com/article/what-is-mpe/) は _MIDI Polyphonic Expression_ の略で、オーディオ製品間で多次元データを通信できるようにする仕様です。

このような [MPE](https://support.roli.com/article/what-is-mpe/) 対応デバイスの例としては、ROLI の Seaboard シリーズ（[Seaboard RISE](https://roli.com/products/seaboard-rise) など）や BLOCKS シリーズ（[Lightpad Block](https://roli.com/products/lightpad-block) など）があります。

コンピューターに [Lightpad Block](https://roli.com/products/lightpad-block) を接続すると、デモアプリケーションのウィンドウは次のスクリーンショットのようになります:

<CaptionImage
  src="/_images/tutorial_mpe_zones_screenshot1.png"
  caption="The demo application"
/>

MIDI 入力のいずれかを有効にする必要があります（ここでは [Lightpad Block](https://roli.com/products/lightpad-block) がオプションとして表示されています）。

[MPE](https://support.roli.com/article/what-is-mpe/) 対応デバイスで演奏されたノートは、[チュートリアル: マルチポリフォニックシンセサイザーの構築](../tutorial_mpe_introduction/)チュートリアルで説明されているように、ウィンドウの下部に表示されます。

## MPE 仕様

入門チュートリアル[チュートリアル: マルチポリフォニックシンセサイザーの構築](../tutorial_mpe_introduction/)では、レガシーモードを使用して標準の MPE 設定プロセスをバイパスすることで、MPE 対応シンセサイザーを簡単に実装できました。このチュートリアルでは、最新の MPE 規格で説明されている手順に従ってシンセサイザーを設定しましょう。

シンセサイザーが MPE モードで動作しているかどうかを判断できるようにすることは、MPE ゾーンの概念に関係しています。MPE Configuration Message（MCM）を使用して少なくとも 1 つのゾーンが定義されている場合、MPE モードになります。それ以外の場合、ゾーンが定義されていない場合は、MPE モードはオフです。では、ゾーンとは何でしょうか？

### MPE ゾーン

ゾーンの概念は、1 つのマスターチャンネルと 1 つ以上のメンバーチャンネルで構成される連続した MIDI チャンネルのグループを表す MPE 固有の用語です。

マスターチャンネルは、ゾーン全体に適用されるメッセージを受信し、メンバーチャンネルは、個別にのみ適用されるメッセージを受信します。

MPE では、最大 2 つのゾーンを持つことができ、Lower ゾーンと Upper ゾーンとして定義されます。

- _Lower Zone_: チャンネル 1 をマスターチャンネルとし、チャンネル 2 から増加して割り当てられる 1 つ以上のメンバーチャンネル。
- _Upper Zone_: チャンネル 16 をマスターチャンネルとし、チャンネル 15 から減少して割り当てられる 1 つ以上のメンバーチャンネル。

メンバーチャンネルは一度に 1 つのゾーンにのみ属することができ、最新の MCM が以前のものより優先されます。

例として、Lower Zone にチャンネル 2 から 10 を含み、Upper Zone にチャンネル 11 から 15 を含むように設定できます。

あるいは、Lower ゾーンまたは Upper ゾーンのいずれかを使用して、単一のゾーンに制限することもできます。ただし、デフォルトでは Lower Zone を使用することをお勧めします。単一ゾーンのシナリオでは、残りの未使用のマスターチャンネルを他のゾーンのメンバーチャンネルとして使用でき、最大 15 個のメンバーチャンネルが得られます。

MPE ゾーンは、メンバーチャンネルなしで MCM をゾーンのマスターチャンネルに送信することでオフにでき、したがって、すべてのゾーンが空の場合、MPE モードはオフになります。

JUCE では、ゾーンの実装は MPEZoneLayout::Zone 構造体にカプセル化されており、[MPEZoneLayout](https://docs.juce.com/master/classMPEZoneLayout.html "This class represents the current MPE zone layout of a device capable of handling MPE.") クラスを使用してさまざまなゾーン設定を定義できます。

ゾーンは、1 つの MPE コントローラーのみを使用してさまざまな音色特性を提供するための便利な手段であり、マスターチャンネルを使用してチャンネルグループ間で MIDI メッセージの伝播を容易にします。

### MIDI モード

MPE でサポートされている主な MIDI モードは、MIDI Mode 3 と 4 の 2 つです。

- **MIDI Mode 3**（_Poly Mode_）: Poly Mode では、単一の MIDI チャンネルで複数のノートを同時に保持できますが、チャンネルメッセージはそのチャンネル上のすべてのアクティブなノートに影響します。新しい MIDI ノートが作成されると、コントローラーは可能な場合は空のチャンネルに割り当てようとし、そうでない場合は既存のアクティブなノートを持つチャンネルに割り当てます。
- **MIDI Mode 4**（_Mono Mode_）: Mono Mode では、単一の MIDI チャンネルは単一のノートのみを保持でき、新しい MIDI ノートが作成されたときに他のチャンネルがいっぱいの場合、コントローラーは既存のアクティブなノートを上書きします。

MPE は MIDI Mode 3（Poly Mode）を使用して適切に動作するように設計されていますが、MIDI Mode 4（Mono Mode）を使用しても使用できます。

### Note Level メッセージと Zone Level メッセージ

MIDI メッセージがマスターチャンネルで送信されるか、メンバーチャンネルで送信されるかによって、それぞれ Zone Level メッセージまたは Note Level メッセージと呼びます。一部のメッセージは、ゾーン内のマスターチャンネルとメンバーチャンネルの両方に送信できます。これが発生した場合、受信シンセサイザーは両方の情報を適切な方法で組み合わせる必要があります。

Zone Level として送信する必要があるメッセージは次のとおりです:

- **CC #1, #33**: _Modulation_ の Control Change。この CC は Note Level で送信できますが、無視されます。
- **CC #7, #39**: _Volume_ の Control Change。この CC は Note Level で送信できますが、無視されます。
- **CC #64**: _Damper Pedal_ の Control Change。この CC は Note Level で送信できますが、無視されます。
- **CC #120**: すべてのサウンドをオフにする Control Change。この CC は Note Level で送信できますが、無視されます。
- **CC #127**: すべてのコントローラーをリセットする Control Change。この CC は Zone Level でのみ送信できます。
- _Polyphonic Key Pressure_: PKP は、マスターチャンネルで送信される MPE 仕様の将来の拡張です。
- _MPE Configuration_（MCM）: MCM は、前述のように設定するためにマスターチャンネルで送信されます。

Zone Level と Note Level の両方として送信できるメッセージは次のとおりです:

- _Pitch Bend_: _Glide_ とも呼ばれる第 1 次元の Control Change。_Pitch Bend_ 情報は、両方のメッセージレベルで受信した場合、組み合わせる必要があります。
- _Channel Pressure_: _Press_ とも呼ばれる第 2 次元の Control Change。_Channel Pressure_ 情報は、両方のメッセージレベルで受信した場合、組み合わせる必要があります。
- _Timbre_（**CC #74**）: _Slide_ とも呼ばれる第 3 次元の Control Change。_Timbre_ 情報は、両方のメッセージレベルで受信した場合、組み合わせる必要があります。
- _Pitch Bend Sensitivity_: ピッチベンド感度を変更する Control Change で、Note Level として使用する場合はすべてのメンバーチャンネルに送信する必要があります。
- _Program Change/Bank Select_: Program Change は、MIDI Mode 4 でメンバーチャンネルに送信される場合を除き、マスターチャンネルで送信されます。

通常 Note Level として送信されるメッセージは次のとおりです:

- _Note On/Off_: _Note On_ および _Note Off_ メッセージは、適切なメンバーチャンネルで送信する必要がありますが、下位互換性のためにマスターチャンネルでも許可されます。
- _MIDI Mode_（**CC #126, #127**）: MIDI Mode 3 と 4 を切り替える Control Change は、最も低いメンバーチャンネルに送信されます。

これらのメッセージレベルは、シンセサイザー内でゾーンを定義する際の設計上の決定に影響するため、覚えておくことが重要です。

## ゾーンの設定

[チュートリアル: マルチポリフォニックシンセサイザーの構築](../tutorial_mpe_introduction/)で実装されたレガシーモードがない場合、少なくとも 1 つのゾーンを設定するまでシンセサイザーは音を出力しません。

`MPESetupComponent` クラスでは、ゾーンの作成と削除を可能にするラムダ関数を使用して 3 つのボタンコールバックを追加します。Lower ゾーンと Upper ゾーンを作成するか、ゾーンレイアウトのすべてのゾーンをクリアできます。

```cpp
MPESetupComponent()
{
    addAndMakeVisible (isLowerZoneButton);
    isLowerZoneButton.setToggleState (true, juce::NotificationType::dontSendNotification);
```

```cpp
addAndMakeVisible (setZoneButton);
setZoneButton.onClick = [this]
{
    auto isLowerZone = isLowerZoneButton.getToggleState();
    auto numMemberChannels = memberChannels.getValue();
    auto perNotePb = notePitchbendRange.getValue();
    auto masterPb = masterPitchbendRange.getValue();

    setZoneButtonClicked (isLowerZone, numMemberChannels, perNotePb, masterPb);
};
```

```cpp
addAndMakeVisible (clearAllZonesButton);
clearAllZonesButton.onClick = [this]
{
    clearAllZonesButtonClicked();
};
```

まず、Lower/Upper ゾーンの選択、メンバーチャンネルの数、Zone Level のピッチベンド、Note Level のピッチベンドを保存する新しいローカル変数を作成します。次に、対応する `setLowerZone()` または `setUpperZone()` 関数を呼び出して、[MPEZoneLayout](https://docs.juce.com/master/classMPEZoneLayout.html "This class represents the current MPE zone layout of a device capable of handling MPE.") オブジェクトにゾーンを設定します。

ゾーンをクリアするときのコールバックを処理するには、次のように [MPEZoneLayout](https://docs.juce.com/master/classMPEZoneLayout.html "This class represents the current MPE zone layout of a device capable of handling MPE.") オブジェクトで `clearAllZones()` 関数を呼び出すだけです:

```cpp
void clearAllZonesButtonClicked()
{
    zoneLayout.clearAllZones();
    listeners.call ([] (Listener& l) { l.allZonesCleared(); });
}
```

## シンセサイザーの設定

`MPESetupComponent` クラスはブロードキャスターとして機能するため、ゾーンレイアウトが変更されたときにコールバックを受信するために、`MainComponent` クラスでリスナーとして登録できます。

```cpp
class MainComponent : public juce::Component,
                      private juce::AudioIODeviceCallback,
                      private juce::MidiInputCallback,
                      private MPESetupComponent::Listener
{
public:
```

その後、対応する関数をオーバーライドして、シンセサイザーを適切に設定できます。

`zoneChanged()` コールバックでは、新しく作成されたゾーンを [MPEZoneLayout](https://docs.juce.com/master/classMPEZoneLayout.html "This class represents the current MPE zone layout of a device capable of handling MPE.") メンバー変数に設定します \[1\]。その後、`setZoneLayout()` を呼び出して [MPEZoneLayout](https://docs.juce.com/master/classMPEZoneLayout.html "This class represents the current MPE zone layout of a device capable of handling MPE.") オブジェクトを [MPESynthesiser](https://docs.juce.com/master/classMPESynthesiser.html "Base class for an MPE-compatible musical device that can play sounds.") に渡すことができます \[2\]:

```cpp
void zoneChanged (bool isLowerZone, int numMemberChannels, int perNotePitchbendRange, int masterPitchbendRange) override
{
    auto* midiOutput = audioDeviceManager.getDefaultMidiOutput();
    if (midiOutput != nullptr)
    {
        if (isLowerZone)
            midiOutput->sendBlockOfMessagesNow (juce::MPEMessages::setLowerZone (numMemberChannels, perNotePitchbendRange, masterPitchbendRange));
        else
            midiOutput->sendBlockOfMessagesNow (juce::MPEMessages::setUpperZone (numMemberChannels, perNotePitchbendRange, masterPitchbendRange));
    }

    if (isLowerZone)
        zoneLayout.setLowerZone (numMemberChannels, perNotePitchbendRange, masterPitchbendRange);
    else
        zoneLayout.setUpperZone (numMemberChannels, perNotePitchbendRange, masterPitchbendRange);

    visualiserInstrument.setZoneLayout (zoneLayout);
    synth.setZoneLayout (zoneLayout);
    colourPicker.setZoneLayout (zoneLayout);
}
```

`allZonesCleared()` コールバックでは、[MPEZoneLayout](https://docs.juce.com/master/classMPEZoneLayout.html "This class represents the current MPE zone layout of a device capable of handling MPE.") メンバー変数のすべてのゾーンを空にします \[3\]。その後、同様に `setZoneLayout()` を呼び出して [MPEZoneLayout](https://docs.juce.com/master/classMPEZoneLayout.html "This class represents the current MPE zone layout of a device capable of handling MPE.") オブジェクトを [MPESynthesiser](https://docs.juce.com/master/classMPESynthesiser.html "Base class for an MPE-compatible musical device that can play sounds.") に渡すことができます \[4\]:

```cpp
void allZonesCleared() override
{
    auto* midiOutput = audioDeviceManager.getDefaultMidiOutput();
    if (midiOutput != nullptr)
        midiOutput->sendBlockOfMessagesNow (juce::MPEMessages::clearAllZones());

    zoneLayout.clearAllZones();
    visualiserInstrument.setZoneLayout (zoneLayout);
    synth.setZoneLayout (zoneLayout);
    colourPicker.setZoneLayout (zoneLayout);
}
```

[MPESynthesiserVoice](https://docs.juce.com/master/classMPESynthesiserVoice.html "Represents an MPE voice that an MPESynthesiser can use to play a sound.") オブジェクトの数が変更されると、`numberOfVoicesChanged()` コールバックを受信します。これにより、[MPESynthesiser](https://docs.juce.com/master/classMPESynthesiser.html "Base class for an MPE-compatible musical device that can play sounds.") オブジェクトでそれぞれ `reduceNumVoices()` および `addVoice()` 関数を使用して、ボイスを削除または追加できます:

```cpp
void numberOfVoicesChanged (int numberOfVoices) override
{
    if (numberOfVoices < synth.getNumVoices())
        synth.reduceNumVoices (numberOfVoices);
    else
        while (synth.getNumVoices() < numberOfVoices)
            synth.addVoice (new MPEDemoSynthVoice());
}
```

## ピッチベンドの割り当て

シンセサイザーを実行すると、ゾーンごとにカスタマイズ可能な数のメンバーチャンネルで Lower ゾーンと Upper ゾーンを追加できます。

<CaptionImage
  src="/_images/tutorial_mpe_zones_screenshot2.png"
  caption="Different zones in the demo application"
/>

Lower ゾーンと Upper ゾーンに異なるピッチベンド感度を割り当てて、異なるゾーンの MIDI チャンネルに割り当てられたノートのピッチベンドへの影響に注目してください。

:::note
演習: `MPEDemoSynthVoice` クラスで Lower ゾーンと Upper ゾーンに異なるサウンドを割り当て、_timbre_ パラメーターに応じて三角波とノコギリ波の間でクロスフェードします。
:::

:::tip
この演習のソースコードは、デモプロジェクトの `MPEZonesTutorial_02.h` ファイルにあります。
:::

## まとめ

このチュートリアルでは、MPE ゾーンとノートを管理する方法を学びました。特に、次のことを行いました:

- Zone と [MPEZoneLayout](https://docs.juce.com/master/classMPEZoneLayout.html "This class represents the current MPE zone layout of a device capable of handling MPE.") を設定する際の規約を学びました。
- MPE と互換性のある 2 つの MIDI モードを理解しました。
- さまざまな Note Level および Zone Level メッセージを探求しました。
- Lower ゾーンと Upper ゾーンに異なるピッチベンド感度を割り当てました。

## 関連項目

- [チュートリアル: マルチポリフォニックシンセサイザーの構築](../tutorial_mpe_introduction/)
- [チュートリアル: MIDI イベントの処理](../tutorial_handling_midi_events/)
- [チュートリアル: MIDI データの作成](../tutorial_midi_message/)
- [チュートリアル: MIDI シンセサイザーの構築](../../synth/tutorial_synth_using_midi_input/)
