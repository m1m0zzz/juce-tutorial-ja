---
title: ValueTreeでUndoManagerを使用する
sidebar_position: 5
tags: [中級]
---

# チュートリアル：ValueTreeでUndoManagerを使用する

<SourcePageLink path="tutorial_undo_manager_value_tree" />

アプリケーションにアンドゥ/リドゥアクションを実装します。[UndoableAction](https://docs.juce.com/master/classUndoableAction.html "Used by the UndoManager class to store an action which can be done and undone.")オブジェクトを使用して以前の中間状態を簡単に復元し、アンドゥ可能なアクションをトランザクションとしてグループ化する方法を学びます。

**レベル:** 中級<br/>
**プラットフォーム:** Windows, macOS, Linux<br/>
**クラス:** [UndoManager](https://docs.juce.com/master/classUndoManager.html "Manages a list of undo/redo commands."), [UndoableAction](https://docs.juce.com/master/classUndoableAction.html "Used by the UndoManager class to store an action which can be done and undone."), [ValueTree](https://docs.juce.com/master/classValueTree.html "A powerful tree structure that can be used to hold free-form data, and which can handle its own undo ..."), [TreeView](https://docs.juce.com/master/classTreeView.html "A tree-view component."), [TreeViewItem](https://docs.juce.com/master/classTreeViewItem.html "An item in a TreeView.")

## はじめに

このチュートリアルは、[チュートリアル：ValueTreeクラス](../tutorial_value_tree/)で説明されている[ValueTree](https://docs.juce.com/master/classValueTree.html "A powerful tree structure that can be used to hold free-form data, and which can handle its own undo ...")オブジェクトの基本的な理解を前提としています。まだ読んでいない場合は、最初にそのチュートリアルを読む必要があります。

このチュートリアルのデモプロジェクトをこちらからダウンロードしてください：[PIP](https://docs.juce.com/tutorials/PIPs/UndoManagerValueTreeTutorial.zip) \| [ZIP](https://docs.juce.com/tutorials/ZIPs/UndoManagerValueTreeTutorial.zip)。プロジェクトを解凍し、最初のヘッダファイルをProjucerで開いてください。

この手順についてサポートが必要な場合は、[チュートリアル：Projucer Part 1: Projucerを始めよう](../../getting-started/tutorial_new_projucer_project/)を参照してください。

## デモプロジェクト

デモプロジェクトは、過去の履歴を簡単に復元できることを示すために、[ValueTree](https://docs.juce.com/master/classValueTree.html "A powerful tree structure that can be used to hold free-form data, and which can handle its own undo ...")オブジェクトと組み合わせて[UndoManager](https://docs.juce.com/master/classUndoManager.html "Manages a list of undo/redo commands.")クラスの使用を説明しています。[TreeView](https://docs.juce.com/master/classTreeView.html "A tree-view component.")と[TreeViewItem](https://docs.juce.com/master/classTreeViewItem.html "An item in a TreeView.")クラスを使用して、[ValueTree](https://docs.juce.com/master/classValueTree.html "A powerful tree structure that can be used to hold free-form data, and which can handle its own undo ...")データをツリー構造として表示します。プロジェクトをビルドして実行すると、以下のようなものが表示されるはずです：

<CaptionImage
  src="/_images/tutorial_undo_manager_value_tree_screenshot1.png"
  caption="デモプロジェクトのアプリケーションウィンドウ"
/>

現時点では、[ValueTree](https://docs.juce.com/master/classValueTree.html "A powerful tree structure that can be used to hold free-form data, and which can handle its own undo ...")ノードをドラッグアンドドロップしてデータ構造の階層を変更できます。また、子を展開したり折りたたんだりできますが、変更をアンドゥおよびリドゥすることはできません。[UndoManager](https://docs.juce.com/master/classUndoManager.html "Manages a list of undo/redo commands.")クラスを使用してその機能を実装してみましょう。

:::tip
ここで紹介するコードは、JUCE Demoの**ValueTreesDemo**と大まかに類似しています。
:::

## アンドゥ/リドゥボタンの追加

まず、アンドゥとリドゥ機能を許可するために、ユーザーインターフェースに2つの[TextButton](https://docs.juce.com/master/classTextButton.html "A button that uses the standard lozenge-shaped background with a line of text on it.")オブジェクトを追加しましょう。このセクションではラムダ関数に精通している必要があり、これらの手順についてサポートが必要な場合は、[チュートリアル：リスナーとブロードキャスター](../../interface-design/tutorial_listeners_and_broadcasters/)を参照できます。

`MainContentComponent`クラスで、各ボタンの[TextButton](https://docs.juce.com/master/classTextButton.html "A button that uses the standard lozenge-shaped background with a line of text on it.")変数を宣言します [1]：

```cpp
juce::TreeView tree;
juce::TextButton undoButton, redoButton; // [1]
std::unique_ptr<ValueTreeItem> rootItem;
```

コンストラクタのメンバー初期化リストで、[TextButton](https://docs.juce.com/master/classTextButton.html "A button that uses the standard lozenge-shaped background with a line of text on it.")オブジェクトのテキストを設定します [2]：

```cpp
MainContentComponent()
    : undoButton ("Undo"),
      redoButton ("Redo") // [2]
{
```

最後に、ボタンを表示可能にし [3]、[Button::onClick](https://docs.juce.com/master/classButton.html#a30b76ab312dc7f66e67596ae20540ec2 "You can assign a lambda to this callback object to have it called when the button is clicked.")ヘルパーオブジェクトに割り当てるラムダ関数を準備します [4]：

```cpp
//...
addAndMakeVisible (undoButton);
addAndMakeVisible (redoButton); // [3]
undoButton.onClick = [this] {};
redoButton.onClick = [this] {}; // [4]

setSize (600, 400);
```

次に、`resized()`メソッドでボタンの境界を設定できます：

```cpp
void resized() override
{
    // これはMainContentComponentがリサイズされるときに呼び出されます。
    // 子コンポーネントを追加する場合、ここでそれらの位置を
    // 更新する必要があります。

    auto r = getLocalBounds();

    auto buttons = r.removeFromBottom (20);
    undoButton.setBounds (buttons.removeFromLeft (100));
    redoButton.setBounds (buttons.removeFromLeft (100));

    tree.setBounds (r);
}
```

## UndoManagerインスタンスを引数として渡す

[ValueTree](https://docs.juce.com/master/classValueTree.html "A powerful tree structure that can be used to hold free-form data, and which can handle its own undo ...")クラスはアンドゥ/リドゥ動作を自動的に処理するため、[UndoableAction](https://docs.juce.com/master/classUndoableAction.html "Used by the UndoManager class to store an action which can be done and undone.")オブジェクトを登録するには[UndoManager](https://docs.juce.com/master/classUndoManager.html "Manages a list of undo/redo commands.")インスタンスをパラメータとして渡すだけです。これを実装するには、まず[UndoManager](https://docs.juce.com/master/classUndoManager.html "Manages a list of undo/redo commands.")クラスのインスタンスを宣言します [1]：

```cpp
juce::UndoManager undoManager; // [1]
```

次に、対応するアンドゥ/リドゥ動作を処理するためにボタンがクリックされたときに呼び出される関数を割り当てます。ラムダ関数で、それぞれ[`UndoManager::undo()`](https://docs.juce.com/master/classUndoManager.html#a39f45c284e8d0df1a0d378e676246931 "Tries to roll-back the last transaction.")と[`UndoManager::redo()`](https://docs.juce.com/master/classUndoManager.html#aaea507a3b9eaea3360c0e393edf69ccb "Tries to redo the last transaction that was undone.")を以下のように呼び出します：

```cpp
addAndMakeVisible (undoButton);
addAndMakeVisible (redoButton); // [3]
undoButton.onClick = [this] { undoManager.undo(); };
redoButton.onClick = [this] { undoManager.redo(); }; // [4]

setSize (600, 400);
```

`ValueTreeItem`クラスでは、[UndoManager](https://docs.juce.com/master/classUndoManager.html "Manages a list of undo/redo commands.")インスタンスへの参照も保持します [2]：

```cpp
private:
    juce::ValueTree tree;
    juce::UndoManager& undoManager; // [2]
```

クラスコンストラクタのメンバー初期化リストで、[UndoManager](https://docs.juce.com/master/classUndoManager.html "Manages a list of undo/redo commands.")参照を割り当てます [3]：

```cpp
ValueTreeItem (const juce::ValueTree& v, juce::UndoManager& um)
    : tree (v), undoManager (um) // [3]
{
```

ValueTreeItemのサブアイテムが再帰的に作成されるたびに、[UndoManager](https://docs.juce.com/master/classUndoManager.html "Manages a list of undo/redo commands.")インスタンスを渡す必要があります [4]：

```cpp
void refreshSubItems()
{
    clearSubItems();

    for (auto i = 0; i < tree.getNumChildren(); ++i)
        addSubItem (new ValueTreeItem (tree.getChild (i), undoManager)); // [4]
}
```

これで、`MainContentComponent`クラスで[UndoManager](https://docs.juce.com/master/classUndoManager.html "Manages a list of undo/redo commands.")インスタンスを渡すことでルートValueTreeItemをインスタンス化できます [5]：

```cpp
tree.setDefaultOpenness (true);
tree.setMultiSelectEnabled (true);
rootItem.reset (new ValueTreeItem (createRootValueTree(), undoManager)); // [5]
tree.setRootItem (rootItem.get());
```

今度は、[TreeView](https://docs.juce.com/master/classTreeView.html "A tree-view component.")に行った変更を登録するために更新が必要な3つの異なるメソッドがあります。

```cpp
void itemDropped (const juce::DragAndDropTarget::SourceDetails&, int insertIndex) override
{
    juce::OwnedArray<juce::ValueTree> selectedTrees;
    getSelectedTreeViewItems (*getOwnerView(), selectedTrees);

    moveItems (*getOwnerView(), selectedTrees, tree, insertIndex, undoManager); // [1]
}

static void moveItems (juce::TreeView& treeView, const juce::OwnedArray<juce::ValueTree>& items, juce::ValueTree newParent, int insertIndex, juce::UndoManager& undoManager)
{
```

```cpp
v.getParent().removeChild (v, &undoManager); // [2]
newParent.addChild (v, insertIndex, &undoManager); // [3]
```

- [1]：アイテムがドラッグアンドドロップされるたびに、移動を処理する静的関数にundoManagerを渡します。
- [2]：前の親から子を削除し、そのアクションをundoManagerに登録する必要があります。
- [3]：次に、新しい親に子を追加し、新しいアクションをundoManagerに登録できます。

`undoManager`参照を[ValueTree](https://docs.juce.com/master/classValueTree.html "A powerful tree structure that can be used to hold free-form data, and which can handle its own undo ...")関数`addChild()`と`removeChild()`に渡すことで、[UndoManager](https://docs.juce.com/master/classUndoManager.html "Manages a list of undo/redo commands.")に裏で`perform()`関数を呼び出すことで[UndoableAction](https://docs.juce.com/master/classUndoableAction.html "Used by the UndoManager class to store an action which can be done and undone.")を実行させます。[UndoableAction](https://docs.juce.com/master/classUndoableAction.html "Used by the UndoManager class to store an action which can be done and undone.")オブジェクトについては、将来のチュートリアルで説明します。

:::note
演習：[Label](https://docs.juce.com/master/classLabel.html "A component that displays a text string, and can optionally become a text editor when clicked.")コンポーネントを使用して、それぞれの[TextButton](https://docs.juce.com/master/classTextButton.html "A button that uses the standard lozenge-shaped background with a line of text on it.")オブジェクトの横に格納されたアンドゥおよびリドゥアクションの説明を表示し、それぞれ`getUndoDescription()`および`getRedoDescription()`関数を使用します。
:::

## イベントをトランザクションとして処理する

[UndoManager](https://docs.juce.com/master/classUndoManager.html "Manages a list of undo/redo commands.")のもう1つの便利な機能は、複数のアクションを単一のアンドゥ/リドゥトランザクションとしてグループ化する機能です。`undoManager`インスタンスで`beginNewTransaction()`関数を呼び出すことで、[UndoManager](https://docs.juce.com/master/classUndoManager.html "Manages a list of undo/redo commands.")の`perform()`関数へのすべての呼び出しは、次の`beginNewTransaction()`呼び出しまでグループ化されます。

例として、`beginNewTransaction()`関数を定期的に呼び出し、アクションのグループをトランザクションとして一緒に格納する[Timer](https://docs.juce.com/master/classTimer.html "Makes repeated callbacks to a virtual method at a specified time interval.")を作成しましょう。`MainContentComponent`で、タイマーコールバックを受け取るために[Timer](https://docs.juce.com/master/classTimer.html "Makes repeated callbacks to a virtual method at a specified time interval.")クラスを継承します [1]：

```cpp
class MainContentComponent : public juce::Component,
                             public juce::DragAndDropContainer,
                             private juce::Timer // [1]
{
public:
```

対応するヘッダファイルでコールバック関数を宣言します [2]：

```cpp
void timerCallback() override // [2]
{
    undoManager.beginNewTransaction(); // [4]
}
```

コンストラクタで、トランザクション呼び出し間の希望する間隔（ミリ秒）でタイマーを開始します [3]：

```cpp
startTimer (500); // [3]
}
```

最後に、タイマーコールバックで[UndoManager](https://docs.juce.com/master/classUndoManager.html "Manages a list of undo/redo commands.")の`beginNewTransaction()`関数を呼び出すことができます [4]：

```cpp
void timerCallback() override // [2]
{
    undoManager.beginNewTransaction(); // [4]
}
```

:::note
演習：タイマーを使用してアクションのグループを分離する代わりに、5つのアンドゥ/リドゥアクションごとにトランザクションを実装してください。
:::

:::tip
このコードの変更版のソースコードは、デモプロジェクトの`UndoManagerTutorial_02.h`ファイルにあります。
:::

## まとめ

このチュートリアルを完了することで、アプリケーションの以前の状態を復元する方法を学びました。特に、以下のことを行いました：

- [UndoableAction](https://docs.juce.com/master/classUndoableAction.html "Used by the UndoManager class to store an action which can be done and undone.")オブジェクトを[UndoManager](https://docs.juce.com/master/classUndoManager.html "Manages a list of undo/redo commands.")オブジェクトに格納しました。
- [UndoManager](https://docs.juce.com/master/classUndoManager.html "Manages a list of undo/redo commands.")インスタンスを[ValueTree](https://docs.juce.com/master/classValueTree.html "A powerful tree structure that can be used to hold free-form data, and which can handle its own undo ...")アクセス関数にパラメータとして渡しました。
- アンドゥ/リドゥアクションのグループをトランザクションとして処理しました。

## 関連項目

- [チュートリアル：ValueTreeクラス](../tutorial_value_tree/)
- [チュートリアル：プラグイン状態の保存と読み込み](../../plugins/tutorial_audio_processor_value_tree_state/)
- [チュートリアル：リスナーとブロードキャスター](../../interface-design/tutorial_listeners_and_broadcasters/)
